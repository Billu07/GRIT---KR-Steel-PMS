// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  admin
  user
}

enum EquipmentStatus {
  active
  inactive
  maintenance
  retired
}

enum Frequency {
  daily
  weekly
  monthly
  quarterly   @map("3-monthly")
  semi_annually @map("6-monthly")
  yearly
}

enum Criticality {
  low
  medium
  high
}

enum MaintenanceType {
  scheduled
  predictive
  corrective
}

enum WorkType {
  mechanical
  electrical
}

enum ProblemType {
  major
  minor
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  email     String?  @unique
  role      Role     @default(user)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  jobs      Job[]    @relation("JobCreator")

  @@map("users")
}

model EquipmentCategory {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  equipment   Equipment[]

  @@map("equipment_categories")
}

model Equipment {
  id                 Int                  @id @default(autoincrement())
  code               String               @unique
  name               String
  categoryId         Int
  category           EquipmentCategory    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  location           String?
  description        String?
  imageUrl           String?              // Supabase Storage public URL
  status             EquipmentStatus      @default(active)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  jobs               Job[]
  maintenanceHistory MaintenanceHistory[]

  @@map("equipment")
}

model Job {
  id                 Int                  @id @default(autoincrement())
  jobCode            String               @unique
  jobName            String
  jobType            String?
  equipmentId        Int
  equipment          Equipment            @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  category           String?
  flag               String?
  dateDone           DateTime
  hoursWorked        Float                @default(0)
  plannedHours       Float
  frequency          Frequency
  dateDue            DateTime
  remainingHours     Float                @default(0)
  criticality        Criticality
  overdueDays        Int                  @default(0)
  createdBy          Int
  creator            User                 @relation("JobCreator", fields: [createdBy], references: [id])
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  maintenanceHistory MaintenanceHistory[]

  @@map("jobs")
}

model MaintenanceHistory {
  id              Int             @id @default(autoincrement())
  equipmentId     Int
  equipment       Equipment       @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  jobId           Int?
  job             Job?            @relation(fields: [jobId], references: [id], onDelete: SetNull)
  type            MaintenanceType @default(scheduled)
  
  // Corrective Maintenance Fields
  interventionDate DateTime?
  serviceStartDate DateTime?
  serviceEndDate   DateTime?
  problemDescription String?
  solutionDetails  String?
  usedParts       String?
  workType        WorkType?
  problemType     ProblemType?
  remarks         String?
  
  performedAt     DateTime        @default(now())
  createdAt       DateTime        @default(now())

  @@map("maintenance_history")
}
