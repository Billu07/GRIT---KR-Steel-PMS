// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  admin
  user
}

enum EquipmentStatus {
  active
  inactive
  maintenance
  retired
}

enum Frequency {
  daily
  weekly
  monthly
  quarterly   @map("3-monthly")
  semi_annually @map("6-monthly")
  yearly
}

enum Criticality {
  low
  medium
  high
}

enum MaintenanceType {
  scheduled
  predictive
  corrective
}

enum WorkType {
  new
  rework
}

enum ProblemType {
  major
  minor
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  email     String?  @unique
  role      Role     @default(user)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tasks     Task[]   @relation("TaskCreator")

  @@map("users")
}

model EquipmentCategory {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  description String?
  equipment   Equipment[]

  @@map("equipment_categories")
}

model Equipment {
  id                 Int                  @id @default(autoincrement())
  code               String               @unique
  name               String
  categoryId         Int
  category           EquipmentCategory    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  location           String?
  description        String?
  imageUrl           String?              // Supabase Storage public URL
  safetyMeasures     String?
  
  // New fields from machinery.csv
  capacity           String?
  model              String?
  serialNumber       String?
  brand              String?
  runningHours       String?
  testCertNumber     String?
  testCertValidity   String?
  testCertApplied    String?

  status             EquipmentStatus      @default(active)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  tasks              Task[]
  maintenanceHistory MaintenanceHistory[]

  @@map("equipment")
}

model Task {
  id                 Int                  @id @default(autoincrement())
  taskId             String               @unique
  taskName           String
  frequency          Frequency
  taskDetail         String?
  equipmentId        Int
  equipment          Equipment            @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  createdBy          Int
  creator            User                 @relation("TaskCreator", fields: [createdBy], references: [id])
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  maintenanceHistory MaintenanceHistory[]

  @@map("tasks")
}

model MaintenanceHistory {
  id              Int             @id @default(autoincrement())
  equipmentId     Int
  equipment       Equipment       @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  taskId          Int?
  task            Task?           @relation(fields: [taskId], references: [id], onDelete: SetNull)
  type            MaintenanceType @default(scheduled)
  
  // Corrective Maintenance Fields
  informationDate  DateTime?
  serviceStartDate DateTime?
  serviceEndDate   DateTime?
  problemDescription String?
  solutionDetails  String?
  usedParts       String?
  workType        WorkType?
  problemType     ProblemType?
  remarks         String?
  
  // Preventive Maintenance Fields
  maintenanceDate DateTime?
  maintenanceDetails String?
  
  performedAt     DateTime        @default(now())
  createdAt       DateTime        @default(now())

  @@map("maintenance_history")
}

model Inventory {
  id              Int      @id @default(autoincrement())
  name            String
  quantity        String?
  description     String?
  swl             String?
  certificateNo   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("inventory")
}
